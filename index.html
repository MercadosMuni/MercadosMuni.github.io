<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta Registros por Mercado</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 1000px; margin-top: 30px; }
    table input { width: 100%; border: none; background: transparent; }
    table input:focus { outline: 1px solid #0d6efd; background: #e9f0ff; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">Consulta y Edici√≥n de Registros</h2>

    <!-- Login -->
    <div id="loginBox">
      <form id="loginForm" class="mb-4">
        <div class="mb-3">
          <label for="usuario" class="form-label">Usuario</label>
          <input type="text" id="usuario" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="clave" class="form-label">Clave</label>
          <input type="password" id="clave" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-primary w-100">Ingresar</button>
        <div id="loginMsg" class="mt-2 text-danger"></div>
      </form>
    </div>

    <!-- Selector de Mercado -->
    <div id="mercadoSelectorBox" style="display:none;" class="mb-4">
      <label for="mercadoSelect" class="form-label">Seleccione Mercado:</label>
      <select id="mercadoSelect" class="form-select" style="max-width: 300px;"></select>
      <button id="cargarMercadoBtn" class="btn btn-primary mt-2">Cargar Registros</button>
    </div>

    <!-- Buscador -->
    <div class="mb-3" id="searchBox" style="display:none;">
      <label class="form-label">Buscar en registros:</label>
      <input type="text" class="form-control" id="searchInput" placeholder="Escribe para filtrar...">
    </div>

    <!-- Tabla y contenido -->
    <div id="contentBox" style="display:none;">
      <div class="mb-3 text-end">
        <button id="logoutBtn" class="btn btn-secondary">Cerrar sesi√≥n</button>
      </div>
      <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-striped table-bordered table-hover" id="registrosTable">
          <thead class="table-dark"></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="statusMsg" class="mt-3 text-center text-muted"></div>
    </div>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx-echRnCqYjR0YgbJthgC0_iSX1hcAMHIDYOwiROAnlFKiJ0bUf4CGbPcB1IF37QreMA/exec'; // ‚Üê Reemplaza con tu URL del Apps Script

    const loginBox = document.getElementById('loginBox');
    const loginForm = document.getElementById('loginForm');
    const loginMsg = document.getElementById('loginMsg');

    const mercadoSelectorBox = document.getElementById('mercadoSelectorBox');
    const mercadoSelect = document.getElementById('mercadoSelect');
    const cargarMercadoBtn = document.getElementById('cargarMercadoBtn');

    const searchBox = document.getElementById('searchBox');
    const searchInput = document.getElementById('searchInput');

    const contentBox = document.getElementById('contentBox');
    const registrosTable = document.getElementById('registrosTable');
    const statusMsg = document.getElementById('statusMsg');
    const logoutBtn = document.getElementById('logoutBtn');

    let currentUser = null;
    let currentRol = null;
    let registrosData = [];
    let headers = [];
    let claveActual = "";

    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      loginMsg.textContent = '';

      const usuario = document.getElementById('usuario').value.trim();
      const clave = document.getElementById('clave').value.trim();

      fetch(`${scriptURL}?usuario=${encodeURIComponent(usuario)}&clave=${encodeURIComponent(clave)}&accion=mercados`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            loginMsg.textContent = data.error;
            return;
          }

          currentUser = usuario;
          claveActual = clave;
          currentRol = null;
          registrosData = [];
          headers = [];

          mercadoSelect.innerHTML = '';
          data.mercados.forEach(m => {
            const option = document.createElement('option');
            option.value = m.codigo;
            option.textContent = m.nombre;
            mercadoSelect.appendChild(option);
          });

          loginBox.style.display = 'none';
          mercadoSelectorBox.style.display = 'block';
        })
        .catch(() => {
          loginMsg.textContent = 'Error al conectar con el servidor';
        });
    });

    cargarMercadoBtn.addEventListener('click', () => {
      const mercadoElegido = mercadoSelect.value;
      if (!mercadoElegido) return;

      statusMsg.textContent = 'Cargando registros...';

      fetch(`${scriptURL}?usuario=${encodeURIComponent(currentUser)}&clave=${encodeURIComponent(claveActual)}&mercado=${encodeURIComponent(mercadoElegido)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            statusMsg.textContent = '‚ùå ' + data.error;
            return;
          }

          currentRol = data.rol;
          registrosData = data.registros;
          headers = registrosData.length > 0 ? Object.keys(registrosData[0]).filter(k => k !== 'id') : [];

          contentBox.style.display = 'block';
          searchBox.style.display = 'block';

          buildTable(headers, registrosData, currentRol === 'admin');
          statusMsg.textContent = '';
        })
        .catch(() => {
          statusMsg.textContent = '‚ùå Error al cargar registros';
        });
    });

    function buildTable(headers, registros, editable) {
      const thead = registrosTable.querySelector('thead');
      const tbody = registrosTable.querySelector('tbody');

      thead.innerHTML = '';
      tbody.innerHTML = '';

      const trHead = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      registros.forEach(reg => {
        const tr = document.createElement('tr');

        headers.forEach(h => {
          const td = document.createElement('td');
          if (editable) {
            const input = document.createElement('input');
            input.value = reg[h] || '';
            input.dataset.id = reg.id;
            input.dataset.field = h;
            input.addEventListener('change', onInputChange);
            td.appendChild(input);
          } else {
            td.textContent = reg[h] || '';
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function onInputChange(e) {
      const input = e.target;
      const id = input.dataset.id;
      const field = input.dataset.field;
      const valor = input.value;

      const reg = registrosData.find(r => r.id == id);
      if (reg) reg[field] = valor;

      statusMsg.textContent = 'Guardando...';

      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({
          usuario: currentUser,
          clave: claveActual,
          id: id,
          [field]: valor
        }),
        headers: { 'Content-Type': 'application/json' }
      })
        .then(res => res.json())
        .then(res => {
          if (res.error) {
            statusMsg.textContent = '‚ùå ' + res.error;
          } else {
            statusMsg.textContent = '‚úÖ Cambios guardados';
            setTimeout(() => (statusMsg.textContent = ''), 3000);
          }
        })
        .catch(() => {
          statusMsg.textContent = '‚ùå Error guardando cambios';
        });
    }

    logoutBtn.addEventListener('click', () => {
      currentUser = null;
      currentRol = null;
      registrosData = [];
      headers = [];
      claveActual = '';
      loginBox.style.display = 'block';
      mercadoSelectorBox.style.display = 'none';
      contentBox.style.display = 'none';
      searchBox.style.display = 'none';
      loginForm.reset();
      statusMsg.textContent = '';
      loginMsg.textContent = '';
    });

    // Buscador funcional con inputs
    searchInput.addEventListener('input', function () {
      const texto = normalizar(this.value);
      const filas = registrosTable.querySelectorAll('tbody tr');
      let coincidencias = 0;

      filas.forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        const coincide = Array.from(celdas).some(td => {
          const input = td.querySelector('input');
          const contenido = input ? input.value : td.textContent;
          return normalizar(contenido).includes(texto);
        });

        fila.style.display = coincide ? '' : 'none';
        if (coincide) coincidencias++;
      });

      statusMsg.textContent = coincidencias === 0 && texto !== ''
        ? 'üîç No se encontraron coincidencias.'
        : '';
    });

    function normalizar(texto) {
      return texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }
  </script>
</body>
</html>
